<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Metal Shredder: Riff Lord</title>
    <style>
        :root {
            --metal-black: #050505;
            --blood-red: #8b0000;
            --chrome: #e0e0e0;
            --note-glow: #00f0ff;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--metal-black);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh;
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #1a1a1a 0%, #050505 100%);
        }

        /* UI Overlay */
        .controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: space-between;
            pointer-events: none; padding: 0 50px; box-sizing: border-box;
        }

        .btn-group { display: flex; gap: 25px; pointer-events: auto; }

        .btn {
            width: 80px; height: 80px;
            background: rgba(40, 40, 40, 0.6);
            border: 4px solid var(--chrome);
            border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 30px;
            user-select: none; -webkit-user-select: none;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .btn:active { 
            background: var(--blood-red); 
            transform: scale(0.95);
            border-color: #ff0000;
        }

        #orientation-warning {
            display: none; position: fixed; inset: 0;
            background: var(--metal-black); color: white;
            z-index: 100; text-align: center; 
            padding-top: 20%; font-size: 24px;
        }

        @media (orientation: portrait) {
            #orientation-warning { display: block; }
        }
    </style>
</head>
<body>

<div id="orientation-warning">ü§ò ROTATE TO LANDSCAPE TO SHRED ü§ò</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div class="controls">
        <div class="btn-group">
            <div class="btn" id="btn-left">‚Üê</div>
            <div class="btn" id="btn-right">‚Üí</div>
        </div>
        <div class="btn-group">
            <div class="btn" id="btn-jump">UP</div>
            <div class="btn" id="btn-shoot">‚ô´</div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- Game Configuration ---
    const CONFIG = {
        gravity: 0.6,
        jumpPower: -14,
        moveSpeed: 6,
        shredCooldown: 200,
        noteSpeed: 10
    };

    let width, height;
    let lastShot = 0;
    
    // --- Game Objects ---
    let player = {
        x: 100, y: 0, w: 50, h: 80,
        vx: 0, vy: 0,
        grounded: false,
        direction: 1,
        state: 'idle',
        shredTimer: 0
    };

    let notes = [];
    let enemies = [];
    let particles = [];
    let keys = { left: false, right: false, jump: false, shoot: false };

    // --- Initialization ---
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        player.y = height - 120;
    }

    // --- Input Handling ---
    const setupBtn = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    };

    setupBtn('btn-left', 'left');
    setupBtn('btn-right', 'right');
    setupBtn('btn-jump', 'jump');
    setupBtn('btn-shoot', 'shoot');

    // --- Procedural Sprite Renderer ---
    function drawPlayer(ctx, p) {
        ctx.save();
        ctx.translate(p.x + p.w / 2, p.y + p.h / 2);
        ctx.scale(p.direction, 1);

        const now = Date.now();
        const bob = Math.sin(now * 0.01) * 3;
        const walkCycle = p.state === 'walk' ? Math.sin(now * 0.02) * 12 : 0;
        
        // 1. Hair (The Metal Mane)
        ctx.fillStyle = "#111";
        ctx.fillRect(-20, -35 + bob, 40, 45); 
        
        // 2. Legs (Leather Pants)
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(-15, 10 + (p.state === 'walk' ? -walkCycle : 0), 10, 25);
        ctx.fillRect(5, 10 + (p.state === 'walk' ? walkCycle : 0), 10, 25);

        // 3. Torso (Vest)
        ctx.fillStyle = "#222";
        ctx.fillRect(-15, -20 + bob, 30, 35);

        // 4. Guitar (Flying V)
        ctx.save();
        if (p.state === 'shred') ctx.rotate(-0.5);
        
        // Guitar Body
        ctx.fillStyle = "#8b0000";
        ctx.beginPath();
        ctx.moveTo(0, 5);
        ctx.lineTo(40, -15);
        ctx.lineTo(40, 25);
        ctx.closePath();
        ctx.fill();
        
        // Neck
        ctx.fillStyle = "#000";
        ctx.fillRect(-30, 2, 40, 5);
        ctx.restore();

        // 5. Head
        ctx.fillStyle = "#ffdbac";
        ctx.fillRect(-10, -35 + bob, 20, 22);
        
        // 6. Strumming Arm
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 4;
        ctx.beginPath();
        const strum = p.state === 'shred' ? Math.sin(now * 0.06) * 10 : 0;
        ctx.moveTo(0, 0);
        ctx.lineTo(20, 5 + strum);
        ctx.stroke();

        ctx.restore();
    }

    // --- Core Logic ---
    function update() {
        // Animation State Management
        if (player.shredTimer > 0) {
            player.state = 'shred';
            player.shredTimer--;
        } else if (!player.grounded) {
            player.state = 'jump';
        } else if (Math.abs(player.vx) > 0.5) {
            player.state = 'walk';
        } else {
            player.state = 'idle';
        }

        // Movement
        if (keys.left) { 
            player.vx = -CONFIG.moveSpeed; 
            player.direction = -1; 
        } else if (keys.right) { 
            player.vx = CONFIG.moveSpeed; 
            player.direction = 1; 
        } else { 
            player.vx *= 0.85; 
        }

        if (keys.jump && player.grounded) {
            player.vy = CONFIG.jumpPower;
            player.grounded = false;
        }

        if (keys.shoot && Date.now() - lastShot > CONFIG.shredCooldown) {
            notes.push({
                x: player.x + (player.direction === 1 ? player.w : 0),
                y: player.y + 30,
                vx: player.direction * CONFIG.noteSpeed,
                symbol: ['‚ô™', '‚ô´', '‚ô≠', '‚ôØ'][Math.floor(Math.random()*4)]
            });
            player.shredTimer = 12;
            lastShot = Date.now();
        }

        // Physics
        player.x += player.vx;
        player.y += player.vy;
        player.vy += CONFIG.gravity;

        if (player.y > height - 120) {
            player.y = height - 120;
            player.vy = 0;
            player.grounded = true;
        }
        player.x = Math.max(0, Math.min(width - player.w, player.x));

        // Note Management
        notes.forEach((n, i) => {
            n.x += n.vx;
            if (n.x < 0 || n.x > width) notes.splice(i, 1);
        });

        // Enemy Spawning & Logic
        if (Math.random() < 0.015) {
            enemies.push({ x: width + 50, y: height - 110, w: 40, h: 70, speed: 3 + Math.random() * 2 });
        }

        enemies.forEach((en, i) => {
            en.x -= en.speed;
            notes.forEach((n, ni) => {
                if (n.x < en.x + en.w && n.x + 20 > en.x && n.y < en.y + en.h && n.y + 20 > en.y) {
                    enemies.splice(i, 1);
                    notes.splice(ni, 1);
                    for(let k=0; k<10; k++) particles.push({
                        x: en.x, y: en.y + 30, 
                        vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, 
                        life: 25 
                    });
                }
            });
            if (en.x < -100) enemies.splice(i, 1);
        });

        // Particle Cleanup
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            if (p.life <= 0) particles.splice(i, 1);
        });
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        // Stage Floor
        ctx.fillStyle = "#111";
        ctx.fillRect(0, height - 40, width, 40);
        ctx.strokeStyle = var(--blood-red);
        ctx.lineWidth = 2;
        ctx.strokeRect(0, height - 40, width, 1);

        // Draw Enemies (The "Pop" Posers)
        ctx.fillStyle = "#444";
        enemies.forEach(en => {
            ctx.fillRect(en.x, en.y, en.w, en.h);
            ctx.fillStyle = "#f00"; // Red eyes
            ctx.fillRect(en.x + 5, en.y + 15, 6, 6);
            ctx.fillRect(en.x + 25, en.y + 15, 6, 6);
            ctx.fillStyle = "#444";
        });

        // Draw Notes
        ctx.fillStyle = var(--note-glow);
        ctx.shadowBlur = 10;
        ctx.shadowColor = var(--note-glow);
        ctx.font = "bold 30px Arial";
        notes.forEach(n => ctx.fillText(n.symbol, n.x, n.y));
        ctx.shadowBlur = 0;

        // Draw Particles
        ctx.fillStyle = "#ff3300";
        particles.forEach(p => ctx.fillRect(p.x, p.y, 3, 3));

        // Draw Player
        drawPlayer(ctx, player);
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    window.addEventListener('resize', resize);
    resize();
    loop();

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed', err));
        });
    }
</script>
</body>
</html>
